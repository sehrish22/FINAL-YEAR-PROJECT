//- users/register.pug
#registerModal.modal(style="display: none;")
  .modal-content
    span.close-btn(data-modal="registerModal") &times;
    .signup-container
      h1 SIGN UP
      form#registerForm.signup-form(method="post" enctype="multipart/form-data")
        .signup-form-group
          label(for="name") Name
          input#registerName(type="text", class="signup-input", name="name", placeholder="Enter your name", required)

        .signup-form-group
          label(for="email") Email
          input#registerEmail(type="email", class="signup-input", name="email", placeholder="Enter your email", required)

        .signup-form-group
          label(for="contact") Contact
          input#registerContact(type="text", class="signup-input", name="contact", placeholder="Enter your phone number", required)

        .signup-form-group
          label(for="role") Account Type
          select#registerRole(name="role", class="signup-input", required)
            option(value="" selected disabled) Select a role
            option(value="seller") Seller
            option(value="buyer") Buyer

        .signup-form-group#storeNameGroup(style="display: none;")
          label(for="storeName") Store Name
          input#storeName(type="text", class="signup-input", name="storeName", placeholder="Enter your store name")

        .signup-form-group
          label(for="password") Password
          input#registerPassword(type="password", class="signup-input", name="password", placeholder="Create a password", required)
          p.password-hint Password must be at least 8 characters with 1 digit and 1 special character.

        .signup-form-group
          label(for="image") Upload Image
          input(type="file", class="form-control", id="image", name="image")

        // Error display block
        #registerErrorMessage(style="color: red; display: none;")

        .signup-form-group
          input.signup-btn.btn-block(type="submit", value="SIGN UP")

        .signup-links
          p Already have an account?
            a.signup-link(href="#" id="openLoginFromRegister") Log In

//- Scripts
script.
  document.addEventListener("DOMContentLoaded", function () {
    const registerModal = document.getElementById("registerModal");
    const loginModal = document.getElementById("loginModal");
    const registerForm = document.getElementById("registerForm");
    const errorMessage = document.getElementById("registerErrorMessage");

    // Role selector toggle
    const roleSelect = document.getElementById("registerRole");
    const storeNameGroup = document.getElementById("storeNameGroup");

    roleSelect?.addEventListener("change", function () {
      if (roleSelect.value === "seller") {
        storeNameGroup.style.display = "block";
      } else {
        storeNameGroup.style.display = "none";
        document.getElementById("storeName").value = "";
      }
    });

    // Close modal (x buttons)
    document.querySelectorAll(".close-btn").forEach(btn => {
      btn.addEventListener("click", function () {
        registerModal.style.display = "none";
        loginModal.style.display = "none";
        errorMessage.style.display = "none";
      });
    });

    // Switch to login modal
    document.getElementById("openLoginFromRegister")?.addEventListener("click", function (e) {
      e.preventDefault();
      registerModal.style.display = "none";
      loginModal.style.display = "block";
    });

    // Close on outside click
    window.addEventListener("click", function (e) {
      if (e.target === registerModal) {
        registerModal.style.display = "none";
      }
    });

    // Submit register form using fetch
    registerForm?.addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(registerForm);

      try {
        const response = await fetch("/users/register", {
          method: "POST",
          body: formData,
          headers: {
            "Accept": "application/json",
            "X-Requested-With": "XMLHttpRequest"
          }
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || "Unknown error occurred");
        }

        const result = await response.json();

        if (result.success) {
          window.location.href = result.redirect;
        }
      } catch (err) {
        errorMessage.textContent = err.message || "An error occurred. Please try again.";
        errorMessage.style.display = "block";
      }
    });
  });
